<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Lottery Optimizer — Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.45;margin:24px;color:#111}
    h1{font-size:24px;margin:0 0 12px}
    .card{border:1px solid #e5e7eb;border-radius:10px;padding:16px;margin:16px 0;background:#fff}
    .row{display:flex;gap:8px;margin-bottom:8px}
    .row label{min-width:190px;color:#374151}
    input[type=text]{flex:1;padding:8px;border:1px solid #d1d5db;border-radius:8px;font-family:inherit}
    .btn{padding:8px 12px;border-radius:8px;border:1px solid #111;background:#111;color:#fff;cursor:pointer}
    .btn:disabled{opacity:0.5;cursor:not-allowed}
    .muted{color:#6b7280;font-size:13px}
    .error{white-space:pre-wrap;border:1px solid #fecaca;background:#fef2f2;color:#991b1b;padding:10px;border-radius:8px;margin-bottom:12px}
    pre{background:#0b1020;color:#e0e8ff;padding:12px;border-radius:8px;overflow:auto;font-size:13px}
    code{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    ul{padding-left:18px}
    .pill{display:inline-block;border:1px solid #d1d5db;border-radius:999px;padding:2px 8px;margin:2px 6px 2px 0;font-size:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .grid .row label{min-width:auto}
  </style>
</head>
<body>
  <h1>Lottery Optimizer — Report</h1>

  {% if import_err %}
    <div class="error"><strong>Import error:</strong>\n{{ import_err }}</div>
  {% endif %}

  <div id="errBox" class="error" style="display:none"></div>

  <div class="card">
    <h3>Run Phase 1 & 2</h3>
    <form id="runForm">
      <div class="grid">
        <div class="row"><label for="LATEST_MM">LATEST_MM (e.g. <code>([10,14,34,40,43], 5)</code>)</label><input id="LATEST_MM" name="LATEST_MM" type="text" placeholder="([10,14,34,40,43], 5)"></div>
        <div class="row"><label for="LATEST_PB">LATEST_PB (e.g. <code>([14,15,32,42,49], 1)</code>)</label><input id="LATEST_PB" name="LATEST_PB" type="text" placeholder="([14,15,32,42,49], 1)"></div>
        <div class="row"><label for="LATEST_IL_JP">LATEST_IL_JP</label><input id="LATEST_IL_JP" name="LATEST_IL_JP" type="text" placeholder="[1,4,5,10,18,49]"></div>
        <div class="row"><label for="LATEST_IL_M1">LATEST_IL_M1</label><input id="LATEST_IL_M1" name="LATEST_IL_M1" type="text" placeholder="[6,8,10,18,26,27]"></div>
        <div class="row"><label for="LATEST_IL_M2">LATEST_IL_M2</label><input id="LATEST_IL_M2" name="LATEST_IL_M2" type="text" placeholder="[2,18,21,27,43,50]"></div>
        <div class="row"><label for="runs">Runs (default 100)</label><input id="runs" name="runs" type="text" value="100"></div>
      </div>
      <div class="row"><label></label><label><input type="checkbox" id="quiet" name="quiet" checked> Quiet progress (10/100, ...)</label></div>
      <div class="row"><label></label><button class="btn" id="runBtn" type="submit">Run Phase 1 & 2</button></div>
    </form>
    <p class="muted">Generates a 50-row batch for each game, prints Phase-1 hits, runs sims, and saves <code>buy_session_*.json</code>.</p>
    <div id="runOut"></div>
  </div>

  <div class="card">
    <h3>Confirm Phase 3</h3>
    <form id="confirmForm">
      <div class="row">
        <label for="saved_path">Saved buy list path (e.g., <code>/tmp/buylists/buy_session_YYYYMMDD_HHMMSS.json</code>)</label>
        <input id="saved_path" name="saved_path" type="text" placeholder="/tmp/buylists/buy_session_YYYYMMDD_HHMMSS.json">
      </div>

      <div class="grid">
        <div class="row"><label for="NWJ_MM">NWJ_MM (e.g. <code>([10,14,34,40,43], 5)</code>)</label><input id="NWJ_MM" name="NWJ_MM" type="text" placeholder="([10,14,34,40,43], 5)"></div>
        <div class="row"><label for="NWJ_PB">NWJ_PB (e.g. <code>([14,15,32,42,49], 1)</code>)</label><input id="NWJ_PB" name="NWJ_PB" type="text" placeholder="([14,15,32,42,49], 1)"></div>
        <div class="row"><label for="NWJ_IL_JP">NWJ_IL_JP</label><input id="NWJ_IL_JP" name="NWJ_IL_JP" type="text" placeholder="[2,7,25,30,44,49]"></div>
        <div class="row"><label for="NWJ_IL_M1">NWJ_IL_M1</label><input id="NWJ_IL_M1" name="NWJ_IL_M1" type="text" placeholder="[10,20,22,23,24,39]"></div>
        <div class="row"><label for="NWJ_IL_M2">NWJ_IL_M2</label><input id="NWJ_IL_M2" name="NWJ_IL_M2" type="text" placeholder="[3,13,19,25,32,33]"></div>
      </div>

      <div class="row"><label></label><label><input type="checkbox" id="recall_headings" name="recall_headings" checked> Also recall Phase-1/2 headings</label></div>
      <div class="row"><label></label><button class="btn" id="confirmBtn" type="submit">Confirm Phase 3</button></div>
    </form>
    <p class="muted">Confirms only against the exact tickets stored in that saved JSON.</p>
    <div id="confirmOut"></div>
  </div>

  <div class="card">
    <h3>Recent buy lists</h3>
    <div id="recentBox" class="muted">Loading…</div>
    <p class="muted">Tip: set an <code>APP_KEY</code> env var and send it as header <code>X-App-Key</code> for basic protection.</p>
  </div>

  <script>
    const errBox = document.getElementById('errBox');

    function showError(msg) {
      errBox.style.display = 'block';
      errBox.textContent = msg;
    }
    function clearError() {
      errBox.style.display = 'none';
      errBox.textContent = '';
    }

    async function callJSON(url, formEl) {
      const fd = new FormData(formEl);
      const resp = await fetch(url, { method: 'POST', body: fd });
      const txt = await resp.text();
      let data = null;
      try { data = JSON.parse(txt); } catch { throw new Error(txt || ('HTTP ' + resp.status)); }
      if (!data.ok) throw new Error(data.error || 'Unknown error');
      return data;
    }

    function renderJSON(div, obj) {
      div.innerHTML = '<pre>' + JSON.stringify(obj, null, 2) + '</pre>';
    }

    document.getElementById('runForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      clearError();
      const out = document.getElementById('runOut');
      out.innerHTML = '<div class="muted">Running…</div>';
      try {
        const data = await callJSON('/run', e.target);
        renderJSON(out, data.result);
        // If we have a saved path, prefill Phase 3 box
        if (data.result && data.result.saved_path) {
          document.getElementById('saved_path').value = data.result.saved_path;
        } else if (data.result && data.result.saved_path_rel) {
          document.getElementById('saved_path').value = '/' + data.result.saved_path_rel.replace(/^\/+/, '');
        }
        loadRecent();
      } catch (err) {
        showError('Error:\\n' + err.message);
        out.innerHTML = '';
      }
    });

    document.getElementById('confirmForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      clearError();
      const out = document.getElementById('confirmOut');
      out.innerHTML = '<div class="muted">Confirming…</div>';
      try {
        const data = await callJSON('/confirm', e.target);
        renderJSON(out, data.result);
      } catch (err) {
        showError('Error:\\n' + err.message);
        out.innerHTML = '';
      }
    });

    async function loadRecent() {
      try {
        const r = await fetch('/recent');
        const data = await r.json();
        const box = document.getElementById('recentBox');
        if (!data.ok || !data.files || data.files.length === 0) {
          box.textContent = 'None yet.';
          return;
        }
        const ul = document.createElement('ul');
        data.files.forEach(f => {
          const li = document.createElement('li');
          li.innerHTML = '<code>' + f + '</code>';
          ul.appendChild(li);
        });
        box.innerHTML = '';
        box.appendChild(ul);
      } catch {
        document.getElementById('recentBox').textContent = 'None yet.';
      }
    }
    loadRecent();
  </script>
</body>
</html>
