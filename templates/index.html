<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Lottery Optimizer</title>
  <style>
    :root { --bg:#fff; --fg:#0b0d12; --muted:#6b7280; --card:#f8fafc; --line:#e5e7eb; --accent:#2563eb; }
    html,body{background:var(--bg);color:var(--fg);font:14px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    h1{margin:0 0 8px 0}
    h2{margin:24px 0 8px 0}
    h3{margin:0 0 8px 0}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px}
    .col-12{grid-column:span 12}.col-8{grid-column:span 8}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}
    label{display:block;font-weight:600;margin:6px 0 4px}
    input[type=text], input[type=date], textarea{width:100%;box-sizing:border-box;border:1px solid var(--line);border-radius:8px;padding:8px;background:#fff}
    textarea{min-height:84px;resize:vertical}
    .btn{appearance:none;border:1px solid var(--line);background:#fff;border-radius:8px;padding:8px 12px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn.small{padding:4px 8px;font-size:12px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0 12px}
    .muted{color:var(--muted);font-size:12px}
    pre{white-space:pre-wrap;word-break:break-word}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Lottery Optimizer</h1>
    <div class="muted">Phase 1 evaluates vs NJ (training), Phase 2 runs 100× for buy lists, Phase 3 confirms vs NWJ.</div>

    <!-- ================= PHASE 1 ================= -->
    <h2>Phase 1 — Evaluation</h2>
    <div class="toolbar">
      <button id="btn_autofill_p1"
              class="btn"
              onclick="window.autofillPhase1 && window.autofillPhase1()">
        Autofill Phase 1 (3rd newest)
      </button>
      <button id="btn_get_recent" class="btn">GET /recent</button>
      <div style="flex:1"></div>
      <label for="hist_date" class="muted">Optional date:</label>
      <input id="hist_date" type="date"/>
      <button id="btn_save_nj" class="btn">Save current NJ → History</button>
    </div>

    <div class="row">
      <div class="card col-6">
        <h3>Newest jackpots (NJ) — paste here</h3>
        <div class="muted mono">Format: <b>[[mains...], bonus]</b> — use <b>null</b> for IL bonus</div>
        <label for="mm_latest">Mega Millions</label>
        <input id="mm_latest" type="text" placeholder='e.g. [[10,14,34,40,43], 5]'/>
        <label for="pb_latest">Powerball</label>
        <input id="pb_latest" type="text" placeholder='e.g. [[7,30,59,64,69], 20]'/>
        <label for="il_jp_latest">IL Lotto — Jackpot (6 mains)</label>
        <input id="il_jp_latest" type="text" placeholder='e.g. [[1,4,5,10,18,49], null]'/>
        <label for="il_m1_latest">IL Lotto — Million 1 (6 mains)</label>
        <input id="il_m1_latest" type="text" placeholder='e.g. [[6,8,10,18,26,27], null]'/>
        <label for="il_m2_latest">IL Lotto — Million 2 (6 mains)</label>
        <input id="il_m2_latest" type="text" placeholder='e.g. [[2,18,21,27,43,50], null]'/>
        <div class="toolbar">
          <button id="btn_run_p1" class="btn primary">Run Phase 1</button>
          <button id="btn_copy_p1" class="btn small">Copy saved path</button>
        </div>
        <div class="muted">Saved Phase-1 path:</div>
        <input id="p1_saved_path" class="mono" type="text" readonly/>
      </div>

      <div class="card col-6">
        <h3>Feeds (Lottery Defeated)</h3>
        <div class="row" style="grid-template-columns:repeat(3,1fr);gap:8px">
          <div>
            <label for="feed_mm">FEED_MM</label>
            <textarea id="feed_mm" placeholder="Top 8 hot numbers: ...&#10;Top 8 overdue numbers: ...&#10;Top 3 hot Mega Ball numbers: ...&#10;Top 3 overdue Mega Ball numbers: ..."></textarea>
          </div>
          <div>
            <label for="feed_pb">FEED_PB</label>
            <textarea id="feed_pb" placeholder="Top 8 hot numbers: ...&#10;Top 8 overdue numbers: ...&#10;Top 3 hot Power Ball numbers: ...&#10;Top 3 overdue Power Ball numbers: ..."></textarea>
          </div>
          <div>
            <label for="feed_il">FEED_IL</label>
            <textarea id="feed_il" placeholder="Top 8 hot numbers: ...&#10;Top 8 overdue numbers: ..."></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- History BLOBs -->
    <div class="row" style="margin-top:8px">
      <div class="card col-4">
        <div class="toolbar">
          <h3 style="margin:0">HIST_MM_BLOB</h3>
          <button id="btn_show_mm_blob" class="btn small">Show</button>
          <button id="btn_copy_mm_blob" class="btn small">Copy</button>
        </div>
        <textarea id="hist_mm_blob" class="mono" placeholder="YYYY-MM-DD 10-14-34-40-43 05&#10;..."></textarea>
      </div>
      <div class="card col-4">
        <div class="toolbar">
          <h3 style="margin:0">HIST_PB_BLOB</h3>
          <button id="btn_show_pb_blob" class="btn small">Show</button>
          <button id="btn_copy_pb_blob" class="btn small">Copy</button>
        </div>
        <textarea id="hist_pb_blob" class="mono" placeholder="YYYY-MM-DD 28-37-42-50-53 19&#10;..."></textarea>
      </div>
      <div class="card col-4">
        <div class="toolbar">
          <h3 style="margin:0">HIST_IL_BLOB</h3>
          <button id="btn_show_il_blob" class="btn small">Show</button>
          <button id="btn_copy_il_blob" class="btn small">Copy</button>
        </div>
        <textarea id="hist_il_blob" class="mono" placeholder="YYYY-MM-DD 01-04-05-10-18-49&#10;..."></textarea>
      </div>
    </div>

    <pre id="autofill_debug" class="mono muted" style="background:#f8fafc;border:1px solid #e5e7eb;border-radius:8px;padding:8px;margin-top:8px;">(autofill debug will appear here)</pre>

    <div class="row" style="margin-top:8px">
      <div class="card col-12">
        <div id="p1_results"><span class="muted">Phase-1 results will appear here.</span></div>
      </div>
    </div>

    <!-- ================= PHASE 2 ================= -->
    <h2>Phase 2 — Prediction (100× runs)</h2>
    <div class="card">
      <div class="toolbar">
        <label class="muted">Saved Phase-1 state file →</label>
        <input id="p2_input_path" class="mono" type="text" style="flex:1" placeholder="/tmp/lotto_phase1_YYYY-MM-DD_HH-MM-SS.json"/>
        <button id="btn_run_p2" class="btn primary">Run Phase 2</button>
        <button id="btn_recent" class="btn">GET /recent</button>
      </div>
      <div class="row">
        <div class="card col-4">
          <h3>MM buy list (10)</h3>
          <pre id="mm_buy" class="mono muted">—</pre>
          <button id="btn_copy_mm" class="btn small">Copy list</button>
        </div>
        <div class="card col-4">
          <h3>PB buy list (10)</h3>
          <pre id="pb_buy" class="mono muted">—</pre>
          <button id="btn_copy_pb" class="btn small">Copy list</button>
        </div>
        <div class="card col-4">
          <h3>IL buy list (15)</h3>
          <pre id="il_buy" class="mono muted">—</pre>
          <button id="btn_copy_il" class="btn small">Copy list</button>
        </div>
      </div>
      <div class="muted" style="margin-top:8px">Saved Phase-2 path:</div>
      <input id="p2_saved_path" class="mono" type="text" readonly/>
      <div class="row" style="margin-top:8px">
        <div class="card col-4"><h3>MM aggregated hits</h3><pre id="mm_agg" class="mono muted">—</pre></div>
        <div class="card col-4"><h3>PB aggregated hits</h3><pre id="pb_agg" class="mono muted">—</pre></div>
        <div class="card col-4"><h3>IL aggregated hits</h3><pre id="il_agg" class="mono muted">—</pre></div>
      </div>
    </div>

    <!-- ================= PHASE 3 ================= -->
    <h2>Phase 3 — Confirmation</h2>
    <div class="toolbar">
      <button id="btn_autofill_p3"
              class="btn"
              onclick="window.autofillPhase3 && window.autofillPhase3()">
        Autofill Phase 3 (NWJ)
      </button>
    </div>
    <div class="card">
      <div class="toolbar">
        <label class="muted">Saved Phase-2 state file →</label>
        <input id="p3_input_path" class="mono" type="text" style="flex:1" placeholder="/tmp/lotto_phase2_YYYY-MM-DD_HH-MM-SS.json"/>
      </div>
      <label for="nwj_json">NWJ (JSON; include only announced games)</label>
      <textarea id="nwj_json" class="mono" placeholder='{"LATEST_MM":[[10,14,34,40,43],5],"LATEST_PB":[[14,15,32,42,49],1],"LATEST_IL_JP":[[1,4,5,10,18,49],null],"LATEST_IL_M1":[[6,8,10,18,26,27],null],"LATEST_IL_M2":[[2,18,21,27,43,50],null]}'></textarea>
      <div class="toolbar">
        <button id="btn_run_p3" class="btn primary">Confirm vs NWJ</button>
      </div>
      <div class="row">
        <div class="card col-4"><h3>MM rows that hit</h3><pre id="mm_c_hits" class="mono muted">—</pre></div>
        <div class="card col-4"><h3>PB rows that hit</h3><pre id="pb_c_hits" class="mono muted">—</pre></div>
        <div class="card col-4"><h3>IL rows that hit (JP/M1/M2)</h3><pre id="il_c_hits" class="mono muted">—</pre></div>
      </div>
    </div>

    <!-- ================= RECENT & EXPORTS ================= -->
    <h2>Recent &amp; Exports</h2>
    <div class="toolbar">
      <button id="btn_recent_bottom" class="btn">GET /recent</button>
      <a class="btn" href="/hist_csv?game=MM" target="_blank">Download MM CSV</a>
      <a class="btn" href="/hist_csv?game=PB" target="_blank">Download PB CSV</a>
      <a class="btn" href="/hist_csv?game=IL" target="_blank">Download IL CSV</a>
    </div>
    <pre id="recent_out" class="mono muted card">—</pre>
  </div>

  <!-- Inline JS for run/copy/blob/save -->
  <script>
    async function postJSON(url, payload) {
      const res = await fetch(url, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error("HTTP " + res.status + " for " + url);
      return await res.json();
    }
    function copyText(id){ const el=document.getElementById(id); if(el && el.value) navigator.clipboard.writeText(el.value); }
    function copyArea(id){ const el=document.getElementById(id); if(el) navigator.clipboard.writeText(el.value||el.textContent||""); }

    // Save current NJ -> history
    document.getElementById("btn_save_nj").addEventListener("click", async ()=>{
      try{
        const payload = {
          draw_date: document.getElementById("hist_date").value || null,
          LATEST_MM: eval(document.getElementById("mm_latest").value||"null"),
          LATEST_PB: eval(document.getElementById("pb_latest").value||"null"),
          LATEST_IL_JP: eval(document.getElementById("il_jp_latest").value||"null"),
          LATEST_IL_M1: eval(document.getElementById("il_m1_latest").value||"null"),
          LATEST_IL_M2: eval(document.getElementById("il_m2_latest").value||"null")
        };
        const out = await postJSON("/hist_add", payload);
        alert("Saved to history: " + JSON.stringify(out.added||[]));
      }catch(e){ alert("Save failed: "+e.message); }
    });

    // Show history BLOBs
    async function showBlob(game, intoId){
      try{
        const r = await fetch("/hist_blob?game="+encodeURIComponent(game), {cache:"no-store"});
        const j = await r.json();
        if(!r.ok || !j.ok) throw new Error(j.detail||("HTTP "+r.status));
        document.getElementById(intoId).value = j.blob || "";
      }catch(e){ alert("Show "+game+" BLOB failed: "+e.message); }
    }
    document.getElementById("btn_show_mm_blob").addEventListener("click", ()=>showBlob("MM","hist_mm_blob"));
    document.getElementById("btn_show_pb_blob").addEventListener("click", ()=>showBlob("PB","hist_pb_blob"));
    document.getElementById("btn_show_il_blob").addEventListener("click", ()=>showBlob("IL","hist_il_blob"));
    document.getElementById("btn_copy_mm_blob").addEventListener("click", ()=>copyArea("hist_mm_blob"));
    document.getElementById("btn_copy_pb_blob").addEventListener("click", ()=>copyArea("hist_pb_blob"));
    document.getElementById("btn_copy_il_blob").addEventListener("click", ()=>copyArea("hist_il_blob"));

    // Phase 1
    document.getElementById("btn_run_p1").addEventListener("click", async ()=>{
      try{
        const body = {
          LATEST_MM: eval(document.getElementById("mm_latest").value||"null"),
          LATEST_PB: eval(document.getElementById("pb_latest").value||"null"),
          LATEST_IL_JP: eval(document.getElementById("il_jp_latest").value||"null"),
          LATEST_IL_M1: eval(document.getElementById("il_m1_latest").value||"null"),
          LATEST_IL_M2: eval(document.getElementById("il_m2_latest").value||"null"),
          FEED_MM: document.getElementById("feed_mm").value||"",
          FEED_PB: document.getElementById("feed_pb").value||"",
          FEED_IL: document.getElementById("feed_il").value||""
        };
        const out = await postJSON("/run_json", body);
        document.getElementById("p1_results").textContent = JSON.stringify(out, null, 2);
        if(out.saved_path){
          document.getElementById("p1_saved_path").value = out.saved_path;
          document.getElementById("p2_input_path").value = out.saved_path;
        }
      }catch(e){ alert("Phase 1 failed: "+e.message); }
    });
    document.getElementById("btn_copy_p1").addEventListener("click", ()=>copyText("p1_saved_path"));

    // Phase 2
    document.getElementById("btn_run_p2").addEventListener("click", async ()=>{
      try{
        const p1 = document.getElementById("p2_input_path").value.trim();
        const out = await postJSON("/run_phase2", { saved_path: p1 });
        document.getElementById("p2_saved_path").value = out.saved_path || "";
        // Buy lists
        document.getElementById("mm_buy").textContent = (out.buy_lists?.MM||[]).map((t,i)=>`${i+1}. ${t.mains.join(", ")}  MB ${t.bonus??"-"}`).join("\n") || "—";
        document.getElementById("pb_buy").textContent = (out.buy_lists?.PB||[]).map((t,i)=>`${i+1}. ${t.mains.join(", ")}  PB ${t.bonus??"-"}`).join("\n") || "—";
        document.getElementById("il_buy").textContent = (out.buy_lists?.IL||[]).map((t,i)=>`${i+1}. ${t.mains.join(", ")}`).join("\n") || "—";
        // Aggregated hits (compact)
        const fmtAgg = (agg)=>Object.entries(agg||{}).map(([k,arr])=>{
          // arr is a flat array of row positions; compute counts
          const cnt = (arr||[]).length;
          const freq = {};
          (arr||[]).forEach(p=>freq[p]=(freq[p]||0)+1);
          const top = Object.entries(freq).sort((a,b)=>b[1]-a[1]||(+a[0])-(+b[0])).slice(0,8).map(([r,c])=>`${r}(${c})`).join(", ");
          return `${k}\t${cnt}\t${top||"—"}`;
        }).join("\n") || "—";
        document.getElementById("mm_agg").textContent = fmtAgg(out.agg_hits?.MM);
        document.getElementById("pb_agg").textContent = fmtAgg(out.agg_hits?.PB);
        // IL contains JP/M1/M2 sub-buckets
        const ilAgg = out.agg_hits?.IL || {};
        const lines = [];
        for (const tier of ["JP","M1","M2"]) {
          const block = ilAgg[tier] || {};
          const row = Object.entries(block).map(([k,arr])=>{
            const cnt = (arr||[]).length;
            const freq = {}; (arr||[]).forEach(p=>freq[p]=(freq[p]||0)+1);
            const top = Object.entries(freq).sort((a,b)=>b[1]-a[1]||(+a[0])-(+b[0])).slice(0,8).map(([r,c])=>`${r}(${c})`).join(", ");
            return `${tier} ${k}\t${cnt}\t${top||"—"}`;
          }).join("\n");
          if (row) lines.push(row);
        }
        document.getElementById("il_agg").textContent = lines.join("\n") || "—";
        if(out.saved_path) document.getElementById("p3_input_path").value = out.saved_path;
      }catch(e){ alert("Phase 2 failed: "+e.message); }
    });

    document.getElementById("btn_copy_mm").addEventListener("click", ()=>navigator.clipboard.writeText(document.getElementById("mm_buy").textContent.trim()));
    document.getElementById("btn_copy_pb").addEventListener("click", ()=>navigator.clipboard.writeText(document.getElementById("pb_buy").textContent.trim()));
    document.getElementById("btn_copy_il").addEventListener("click", ()=>navigator.clipboard.writeText(document.getElementById("il_buy").textContent.trim()));

    // Phase 3
    document.getElementById("btn_run_p3").addEventListener("click", async ()=>{
      try{
        const p2 = document.getElementById("p3_input_path").value.trim();
        const nwj = JSON.parse(document.getElementById("nwj_json").value||"{}");
        const out = await postJSON("/confirm_json", { saved_path: p2, NWJ: nwj });
        const fmtHits=(obj)=>Object.entries(obj||{}).map(([k,v])=>`${k}\t${(v||[]).join(", ")||"—"}`).join("\n") || "—";
        document.getElementById("mm_c_hits").textContent = fmtHits(out.MM||{});
        document.getElementById("pb_c_hits").textContent = fmtHits(out.PB||{});
        const ilLines=[];
        if(out.IL){
          for(const k of ["JP","M1","M2"]){
            const block = out.IL[k]||{};
            const row = Object.entries(block).map(([t,arr])=>`${k} ${t}: ${(arr||[]).join(", ")||"—"}`).join("\n");
            if(row) ilLines.push(row);
          }
        }
        document.getElementById("il_c_hits").textContent = ilLines.join("\n") || "—";
      }catch(e){ alert("Confirm failed: "+e.message); }
    });

    // Recent
    async function loadRecent(){
      try{
        const r = await fetch("/recent",{cache:"no-store"});
        const j = await r.json().catch(()=>null);
        document.getElementById("recent_out").textContent = j ? JSON.stringify(j, null, 2) : await r.text();
      }catch(e){ alert("GET /recent failed: "+e.message); }
    }
    document.getElementById("btn_recent").addEventListener("click", loadRecent);
    document.getElementById("btn_recent_bottom").addEventListener("click", loadRecent);
    document.getElementById("btn_get_recent").addEventListener("click", loadRecent);
  </script>

  <!-- External Autofill (cache-busted) -->
  <script src="/static/app.js?v=5"></script>
</body>
</html>
